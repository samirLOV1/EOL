---
title: "Oxygen"
author: "Mégane"
date: "2023-05-08"
output: html_document
---

```{r libraries, echo=FALSE, warning=FALSE, message=FALSE}
library("readr")
library("viridis")
library("scales")
library("lubridate")
library("gsignal")
library("FactoMineR")
library("factoextra")
library("gplots")
library("heatwaveR")
library("dplyr")
library("imputeTS")
library("Metrics")
library("tidyr")
library("tseries")
library("forecast")
library("tsDyn")
library("tsoutliers")
library("seacarb")
library("lmodel2")
library("lmtest")
library("ggExtra")
library("corrplot")
library("ggcorrplot")
library("marelac")
library("kableExtra")
library("stringr")
library("berryFunctions")
library("LakeMetabolizer")
library("rMR")
library("EnvStats")
library("xts")

```


```{r data oxygen EOL, echo=FALSE, warning=FALSE, message=FALSE}

#oxygen EOL : only from 05-05-2017 - mars.2023
#frequency : hourly (raw)
#unity : umol/kg
data_EOL <- read_delim("../Data/data_EOL/EOL_18-23_hourly.csv", 
    delim = ";", escape_double = FALSE, trim_ws = TRUE) %>% 
  dplyr::filter(datetime <= "2022-11-22")


```

## EOL - oxygen time series trend analysis by residuals (substracting climatological monthly means) - jan.2018 - nov.2022
  
*Analysis without interpolations*  
  

```{r trend analysis EOL oxy, echo=FALSE, warning=FALSE, message=FALSE}

data_EOL <- data_EOL %>% 
  mutate(Month = format(datetime, format = "%m"))


## Monthly means EOL oxygen :

monthly_means_EOL_oxy <- ungroup(data_EOL) %>% 
  group_by(Month) %>%
  summarise(oxy_EOL_month = mean(oxy_umol_kg, na.rm = TRUE))

##

## Parameters

anomalies_EOL_oxy <- left_join(ungroup(data_EOL), monthly_means_EOL_oxy, by = "Month") %>%
  mutate(oxy_EOL_ano = oxy_umol_kg - oxy_EOL_month)



# Regression and table anomalies
var_list <- "oxy_EOL_ano"

lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), data = anomalies_EOL_oxy))
})

reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}
colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg) <- var_list
reg_ano_EOL_oxy <- reg

#reg_ano_EOL_oxy #pourquoi p-value = 0


## Plot anomalies EOL oxy :

#plot 1 : raw oxygen data
plot_ano_EOL_oxy_raw <- ggplot(data = anomalies_EOL_oxy, aes(x = datetime, y = oxy_EOL_ano), na.rm=TRUE) +
  scale_x_date(date_breaks="1 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="#2C75FF", na.rm=TRUE, size = 0.8) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title="Anomalies trend for EOL oxygen data (2018-2022)",x="", y="Oxygen (µmol/kg)") +
  annotate(geom="text", x=as.Date("2020-04-22 04:00:00"), y=50, label="slope : -1.21 ± 0.027 *", color="black")

plot_EOL_oxy_raw <- data_EOL %>% 
  ggplot() +
  aes(x=datetime, y=oxy_umol_kg) + 
  geom_line(size=0.8, col = "#22427C", linewidth = 0.5) +
  scale_x_date(name="", date_breaks="1 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  scale_y_continuous(name="Oxygen (µmol/kg)") +
  ggtitle("EOL oxygen time series in µmol/kg (2018-2022)")
#geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE)
##

plot_EOL_oxy_raw
plot_ano_EOL_oxy_raw
```
  
  
  
## Point B - oxygen time series trend analysis by residuals (substracting climatological monthly means)  
  
*Analysis with interpolations* 
  
###### → surface data (1m) : same results as raw  
  
  
```{r data oxygen SOMLIT - surface, echo=FALSE, warning=FALSE, message=FALSE}

#oxygen somlit surface : jan.2002 - dec.2022
#frequency : weekly (clean + impute)
#unity : ml/l and µmol/kg

data_somlit_surf <- read_delim("../Data/data_PointB/DATA_SOMLIT_02-22_oxy_CLEAN_impute_0m.csv", 
    delim = ";", escape_double = FALSE, trim_ws = TRUE) %>% 
  mutate(oxy_umol_kg = case_when(oxy_umol_kg < 170 ~ NA_real_, TRUE ~ oxy_umol_kg))

data_somlit_surf <- data_somlit_surf[c(2:1085),]

data_somlit_surf$oxy_umol_kg <- na_seadec(data_somlit_surf$oxy_umol_kg, algorithm="interpolation")

```


→ Trend analysis by residuals (Bates et al. 2014) :  
  
Observed dissolved oxygen : positive trend (Garcia et al., 2005)  
*slope : 0.33 ± 0.061 μmol/kg per year*  
  

```{r trend analysis SOMLIT oxy - surface, echo=FALSE, warning=FALSE, message=FALSE, fig.width=7, fig.height=4}


## Monthly means surface :

monthly_means_somlit_surf <- ungroup(data_somlit_surf) %>% 
  group_by(month) %>%
  summarise(oxy_somlit_month = mean(oxy_umol_kg, na.rm = TRUE))

##

## Parameters

anomalies_somlit_surf <- left_join(ungroup(data_somlit_surf), monthly_means_somlit_surf, by = "month") %>%
  mutate(oxy_somlit_ano = oxy_umol_kg - oxy_somlit_month)



# Regressions and tables of key parameters
var_list <- "oxy_umol_kg"

lm.test <- vector("list", length(var_list))

for(i in seq_along(var_list)){
  lm.test[[i]] <- lm(reformulate(var_list[i], "datetime"), data = anomalies_somlit_surf)
}



lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), 
             data = anomalies_somlit_surf))
})

reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}

colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg) <- var_list
reg_ano_somlit_surf <- reg

# Regression and table anomalies
var_list <- "oxy_somlit_ano"

lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), data = anomalies_somlit_surf))
})

reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}
colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg) <- var_list
reg_ano_somlit_surf <- reg

#reg_ano_somlit_surf 


## Plot anomalies Point B surface :

plot_ano_somlit_surf <- ggplot(data = anomalies_somlit_surf, aes(x = datetime, y = oxy_somlit_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="2 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="#2C75FF", na.rm=TRUE, size = 0.8) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title="Anomalies trend for oxygen data (surface) at Point B (2002-2022)",x="", y="Oxygen (μmol/kg)") +
  annotate(geom="text", x=as.POSIXct("2020-04-22 04:00:00"), y=50, label="slope : 0.33 ± 0.059 *", color="black")


plot_somlit_surf <- data_somlit_surf %>% 
  ggplot() +
  aes(x=datetime, y=oxy_umol_kg) + 
  geom_line(size=0.8, col = "#22427C", linewidth = 0.5) +
  scale_x_datetime(name="", date_breaks="2 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  scale_y_continuous(name=expression(paste("AOU (", mu, "μmol", .kg^-1, ")")))
#  ggtitle("Point B oxygen time series (surface) in μmol/kg (2002-2022)")
#geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE)
##

plot_somlit_surf
plot_ano_somlit_surf
```
  

###### → 50 m data : same results as raw data  
  
  
```{r data oxygen SOMLIT - 50m, echo=FALSE, warning=FALSE, message=FALSE}

#oxygen somlit 50m : jan.2002 - dec.2022
#frequency : weekly (clean + impute)
#unity : ml/l and µmol/kg

data_somlit_prof <- read_delim("../Data/data_PointB/DATA_SOMLIT_02-22_oxy_CLEAN_impute_50m.csv", 
    delim = ";", escape_double = FALSE, trim_ws = TRUE) %>% 
  mutate(oxy_umol_kg = case_when(oxy_umol_kg < 170 ~ NA_real_, TRUE ~ oxy_umol_kg),
         oxy_umol_kg = case_when(oxy_umol_kg > 340 ~ NA_real_, TRUE ~ oxy_umol_kg))

data_somlit_prof <- data_somlit_prof[c(2:1083),]

data_somlit_prof$oxy_umol_kg <- na_seadec(data_somlit_prof$oxy_umol_kg, algorithm="interpolation")
```

→ Trend analysis by residuals (Bates et al. 2014) :  
  
Observed dissolved oxygen : positive trend (Garcia et al., 2005)  
*slope : 0.20 ± 0.068 μmol/kg per year*  
  
```{r trend analysis SOMLIT oxy - 50m, echo=FALSE, warning=FALSE, message=FALSE, fig.width=7, fig.height=4}


## Monthly means 50m :
monthly_means_somlit_prof <- ungroup(data_somlit_prof) %>% 
  group_by(month) %>%
  summarise(oxy_somlit_month = mean(oxy_umol_kg, na.rm = TRUE))

##

## Parameters

anomalies_somlit_prof <- left_join(ungroup(data_somlit_prof), monthly_means_somlit_prof, by = "month") %>%
  mutate(oxy_somlit_ano = oxy_umol_kg - oxy_somlit_month)



# Regressions and tables of key parameters
var_list <- "oxy_umol_kg"

lm.test <- vector("list", length(var_list))

for(i in seq_along(var_list)){
  lm.test[[i]] <- lm(reformulate(var_list[i], "datetime"), data = anomalies_somlit_prof)
}



lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), 
             data = anomalies_somlit_prof))
})

reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}

colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg) <- var_list
reg_ano_somlit_prof <- reg

# Regression and table anomalies
var_list <- "oxy_somlit_ano"

lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), data = anomalies_somlit_prof))
})

reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}
colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg) <- var_list
reg_ano_somlit_prof <- reg

#reg_ano_somlit_prof 


## Plot anomalies Point B 50m :

plot_ano_somlit_prof <- ggplot(data = anomalies_somlit_prof, aes(x = datetime, y = oxy_somlit_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="2 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="#2C75FF", na.rm=TRUE, size = 0.8) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title="Anomalies trend for oxygen data (50m) at Point B (2002-2022)",x="", y="Oxygen (μmol/kg)") +
  annotate(geom="text", x=as.POSIXct("2020-04-22 04:00:00"), y=50, label="slope : 0.19 ± 0.064 *", color="black")


plot_somlit_prof <- data_somlit_prof %>% 
  ggplot() +
  aes(x=datetime, y=oxy_umol_kg) + 
  geom_line(size=0.8, col = "#22427C", linewidth = 0.5) +
  scale_x_datetime(name="", date_breaks="2 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  scale_y_continuous(name=expression(paste("AOU (", mu, "μmol", .kg^-1, ")")), limits=c(175,300), breaks=c(175, 200, 225, 250, 275, 300))
#geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE)
##

plot_somlit_prof
plot_ano_somlit_prof
```
  
  
## EOL : AOU calculation (Apparent Oxygen Utilisation) :  
  
Period : jan.2018 - nov.2022  
  
AOU  = [O~2~ saturation] in µmol/kg  - [O~2~ observed] in µmol/kg  
Unity : µmol/kg  
  

```{r EOL : AOU, echo=FALSE, warning=FALSE, message=FALSE}

#calcul T1 :
T1 <- (data_EOL$temp_eol_c + 273.15) / 100

#calcul OSAT (ml/kg) :
OSAT = (-173.9894) + 255.5907/T1 + 146.4813*log(T1) - 22.2040*T1
OSAT = OSAT + data_EOL$sal_eol_psu * (-0.037362 + T1 * (0.016504 - 0.0020564 * T1))
OSAT = exp(OSAT)

#convert from ml/kg to umol/kg : NON
#OSAT = (OSAT * 1000)/ 22.392

#calculate AOU in umol/kg
AOU_EOL = OSAT - data_EOL$oxy_umol_kg

data_EOL <- data_EOL %>% 
  mutate(AOU = AOU_EOL)

data_EOL <- cbind(data_EOL, OSAT)


#negative AOU (Garcia et al., 2005)
# −AOU = O2 − OSAT

data_EOL <- data_EOL %>% 
  mutate(neg_AOU = oxy_umol_kg - OSAT) %>% 
  group_by(Year) %>% 
  mutate(mean_AOU = mean(AOU, na.rm = T))


## save
#write.table(data_EOL, "EOL_18-23_hourly_AOU.csv", sep=";", col.names = TRUE, row.names = FALSE)


```
  
  
→ AOU (EOL) annual cycle :  
  
AOU : valeurs majoritairement négatives = 
*plus faibles valeurs en été*  
  
*scatter plot : Temp. influence significativement AOU (r = -0.90) : quand T augmente, AOU diminue*  
  
Shifts : 2020 and 2021  
  

```{r AOU EOL + annual cycle, echo=FALSE, warning=FALSE, message=FALSE}

plot_AOU_EOL <- data_EOL %>% 
  ggplot() + 
  aes(x=datetime, y=AOU) + 
  geom_line(col = "black", size = 0.5) + 
  scale_x_date(name="", date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) + 
  scale_y_continuous(name=expression(paste("AOU (µmol ", kg^-1, ")")))
##

plot_AOU_EOL_annual_cycle <- data_EOL %>% 
  ggplot() +
  geom_line(aes(x = as.Date(yday(datetime), "1970-01-01"), y = AOU, 
                group = factor(year(datetime)), 
                color = factor(year(datetime))), linewidth = 0.6) +
  scale_colour_viridis_d(option="mako", direction=-1) +
  ggtitle("Annual cycle of AOU (surface) - EOL (2018-2022)") +
  scale_x_date(date_breaks="months", date_labels="%b", name = "") +
  labs(x="Months",colour="") +
  theme_bw() +
  scale_y_continuous(name = "AOU (µmol/kg)") 
##

plot_AOU_EOL
plot_AOU_EOL_annual_cycle
##

#scatter plot DO vs T
data_EOL %>% 
  ggplot() +
  aes(x=temp_eol_c, y=oxy_umol_kg) + 
  geom_point() + 
  scale_x_continuous(name="Temp. (°C)") + 
  scale_y_continuous(name="DO (µmol/kg)") +
  ggtitle("DO according to temperature : EOL (2018-2022)") +
  geom_smooth(method=lm) + 
  annotate(geom="text", x=25, y=260, label="slope : -3.55 ± 0.009 *", color="black")

#summary(lm(data_EOL$oxy_umol_kg ~ data_EOL$temp_eol_c))
#cor.test(data_EOL$temp_eol_c, data_EOL$oxy_umol_kg, na.action=na.omit)

#Mean AOU by year :

data_EOL %>% 
  ggplot() +
  aes(x=Year, y=mean_AOU) +
  geom_point(shape = 7, size = 2, col="brown") +
  geom_line() +
  scale_x_discrete(name="", limits=c("2018" : "2022")) + 
  scale_y_continuous(name="AOU (µmol/kg)") +
  ggtitle("Mean of AOU per year at EOL - surface (2018-2022)")

```
  
  
  
###### Trend analysis by residuals - AOU - EOL (Bates et al. 2014) :  
  
Positive trend :  
*slope : 1.34 ± 0.023 µmol/kg per year*  
  

```{r trend analysis AOU - EOL, echo=FALSE, warning=FALSE, message=FALSE}

## Monthly means AOU EOL :
monthly_means_AOU_EOL <- ungroup(data_EOL) %>% 
  group_by(Month) %>%
  summarise(AOU_month = mean(AOU, na.rm = TRUE),
            SD_AOU = sd(AOU, na.rm = TRUE),
            neg_AOU_month = mean(neg_AOU, na.rm = TRUE),
            OSAT_month = mean(OSAT, na.rm = TRUE),
            DO_month = mean(oxy_umol_kg, na.rm = TRUE))

##

## Parameters

anomalies_AOU_EOL <- left_join(ungroup(data_EOL), monthly_means_AOU_EOL, by = "Month") %>%
  mutate(AOU_ano = AOU - AOU_month,
         neg_AOU_ano = neg_AOU - neg_AOU_month,
         OSAT_ano = OSAT - OSAT_month,
         DO_ano = oxy_umol_kg - DO_month)



# Regression and table anomalies
var_list <- c("AOU_ano", "neg_AOU_ano", "OSAT_ano", "DO_ano")

lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), data = anomalies_AOU_EOL))
})

reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}
colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg) <- var_list
reg_ano_AOU_EOL <- reg

#reg_ano_AOU_EOL 


#plot anomalies AOU surface :
plot_ano_AOU_EOL <- ggplot(data = anomalies_AOU_EOL, aes(x = datetime, y = AOU_ano), na.rm=TRUE) +
  scale_x_date(date_breaks="1 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="#2C75FF", na.rm=TRUE, size = 0.8) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title="Anomalies trend for AOU at EOL (2018-2022)",x="", y="AOU (µmol/kg)") +
  annotate(geom="text", x=as.Date("2020-04-22 04:00:00"), y=50, label="slope : 1.35 ± 0.023 *", color="black")



plot_AOU_EOL
plot_ano_AOU_EOL

```
  
  
→ Plot mean annual anomalies of O~2~, O~2~sat and negative AOU (Mavropoulou et al., 2020)  
  
Negative AOU and dissolved oxygen are similar in magnitude all over the period  
O~2~sat is close to zero  
DO and O~2~sat are similar in magnitude for 2018-2020  
  
→ thus, the solubility changes have a secondary role in the observed dissolved oxygen variations  
  

```{r plot mean annual O2, O2 sat & AOU monthly means - EOL, echo=FALSE, warning=FALSE, message=FALSE, fig.width=9,fig.height=4}

anomalies_AOU_EOL <- anomalies_AOU_EOL %>% 
  group_by(Year) %>% 
  mutate(mean_neg_AOU_ano = mean(neg_AOU_ano, na.rm=TRUE),
         mean_OSAT_ano = mean(OSAT_ano, na.rm=TRUE),
         mean_DO_ano = mean(DO_ano, na.rm=TRUE))

anomalies_AOU_EOL %>%
ggplot() + 
  geom_point(aes(x=Year, y=mean_neg_AOU_ano), col="black") +
  geom_line(aes(x=Year, y=mean_neg_AOU_ano), col="black") +
  geom_point(aes(x=Year, y=mean_OSAT_ano), col="darkred") +
  geom_line(aes(x=Year, y=mean_OSAT_ano), col="darkred") +
  geom_point(aes(x=Year, y=mean_DO_ano), col="#048B9A") + 
  geom_line(aes(x=Year, y=mean_DO_ano), col="#048B9A") +
  scale_y_continuous(name="Oxygen(µmol/kg)") +
  scale_x_discrete(name="", limits = c("2018" : "2022"))


```
  
  
  
## Point B - AOU calculation (Apparent Oxygen Utilisation) :  
  
AOU  = [O~2~ saturation] in µmol/kg  - [O~2~ observed] in µmol/kg  
Unity : µmol/kg  
  
OSAT : driven by temperature  
  
AOU removes the effect of OSAT, which is primarily driven by temperature  
  
###### → surface data (1m) :  
  

```{r AOU calculation - SOMLIT surface, echo=FALSE, warning=FALSE, message=FALSE}

#calcul T1 :
T1 <- (data_somlit_surf$T + 273.15) / 100

#calcul OSAT (ml/kg) :
OSAT = (-173.9894) + 255.5907/T1 + 146.4813*log(T1) - 22.2040*T1
OSAT = OSAT + data_somlit_surf$S * (-0.037362 + T1 * (0.016504 - 0.0020564 * T1))
OSAT = exp(OSAT)

#convert from ml/kg to umol/kg : NON
#OSAT = (OSAT * 1000)/ 22.392

#calculate AOU in umol/kg
AOU_som_surf = OSAT - data_somlit_surf$oxy_umol_kg



data_somlit_surf <- data_somlit_surf %>% 
  mutate(AOU = AOU_som_surf) 

data_somlit_surf <- cbind(data_somlit_surf, OSAT)


#negative AOU (Garcia et al., 2005)
# −AOU = O2 − OSAT

data_somlit_surf <- data_somlit_surf %>% 
  mutate(neg_AOU = oxy_umol_kg - OSAT) %>% 
  group_by(year) %>% 
  mutate(mean_AOU = mean(AOU, na.rm = T))


## save
#write.table(data_somlit_surf, "DATA_SOMLIT_02-22_oxy_CLEAN_impute_0m_AOU.csv", sep=";", col.names = TRUE, row.names = FALSE)

```
  

→ AOU (surface) annual cycle : low values in summer  
  
Temperature and DO are correlated (r = -0.66) : when temp. increases, DO decreases  
  

```{r AOU surface + annual cycle, echo=FALSE, warning=FALSE, message=FALSE}

plot_AOU_surf_annual_cycle <- data_somlit_surf %>% 
  ggplot() +
  geom_line(aes(x = as.Date(yday(datetime), "1970-01-01"), y = AOU, 
                group = factor(year(datetime)), 
                color = factor(year(datetime))), linewidth = 0.6) +
  scale_colour_viridis_d(option="mako", direction=-1) +
  ggtitle("Annual cycle of AOU (surface) - Point B (2002-2022)") +
  scale_x_date(date_breaks="months", date_labels="%b", name = "") +
  labs(x="Months",colour="") +
  theme_bw() +
  scale_y_continuous(name = "AOU (µmol/kg)") 

plot_AOU_surf_annual_cycle
##

#scatter plot DO vs T
data_somlit_surf %>% 
  ggplot() +
  aes(x=T, y=oxy_umol_kg) + 
  geom_point() + 
  scale_x_continuous(name="Temp. (°C)") + 
  scale_y_continuous(name="DO (µmol/kg)") +
  ggtitle("Correlation between temperature and DO at Point B (2002-2022)") +
  geom_smooth(method=lm) + 
  annotate(geom="text", x=22, y=125, label="slope : -2.72 ± 0.09 *", color="black")

#summary(lm(data_somlit_surf$oxy_umol_kg ~ data_somlit_surf$T))
#cor(data_somlit_surf$T, data_somlit_surf$oxy_umol_kg)
##

#Mean AOU by year :

data_somlit_surf <- data_somlit_surf %>% 
  group_by(year) %>% 
  mutate(mean_AOU = mean(AOU, na.rm = T))
  
data_somlit_surf %>% 
  ggplot() +
  aes(x=year, y=mean_AOU) +
  geom_point(shape = 7, size = 2, col="brown") +
  geom_line() +
  scale_x_discrete(name="", limits=c("2002" : "2022")) + 
  scale_y_continuous(name="AOU (µmol/kg)") +
  ggtitle("Mean of AOU per year at Point B - surface (2002-2022)")


```
  
  
→ AOU (surface) minima and maxima evolution (2002-2022) :  
  

```{r AOU minima and maxima - surface, echo=FALSE, warning=FALSE, message=FALSE}

AOU_minima_maxima_surf <- data_somlit_surf %>% 
  group_by(year) %>% 
  mutate(AOU_min = min(AOU, na.rm = TRUE),
         AOU_max = max(AOU, na.rm = TRUE),
         mean_AOU = mean(AOU, na.rm = T))
##

AOU_minima_surf_long <- AOU_minima_maxima_surf %>% 
  rename(`AOU minima` = AOU_min, `AOU maxima` = AOU_max, `AOU mean` = mean_AOU) %>% 
  pivot_longer(cols = c(`AOU minima`, `AOU mean`, `AOU maxima`), names_to = "Legend", values_to = "value")

#plot
plot_AOU_min_max_mean_surf <- AOU_minima_surf_long %>% 
  ggplot() +
  ggtitle("AOU minima, maxima and mean per year - Point B (2002-2022)") +
  geom_point(aes(x=year, y=value, color= Legend), size=1) +
  geom_line(aes(x=year, y=value, color= Legend), size=0.7) +
  scale_y_continuous(name="AOU (µmol/kg)") + 
  scale_x_discrete(name="", limits = c(2002 :2022)) + 
  scale_colour_discrete(type=c("#CC5500", "black", "#6D071A"))

plot_AOU_min_max_mean_surf

```
  
  
###### Trend analysis by residuals - AOU - surface (Bates et al. 2014) :  
  
AOU : negative trend (Garcia et al., 2005)  
Inverse relation between AOU and observed O~2~  
*slope : -0.50 ± 0.060 µmol/kg par année* 

```{r trend analysis AOU - surface, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8, fig.height=1.5}

## Monthly means AOU surface :
monthly_means_AOU_surf <- ungroup(data_somlit_surf) %>% 
  group_by(month) %>%
  summarise(AOU_month = mean(AOU, na.rm = TRUE),
            OSAT_month = mean(OSAT, na.rm = TRUE),
            neg_AOU_month = mean(neg_AOU, na.rm = TRUE),
            DO_month = mean(oxy_umol_kg, na.rm= TRUE))

##

## Parameters

anomalies_AOU_surf <- left_join(ungroup(data_somlit_surf), monthly_means_AOU_surf, by = "month") %>%
  mutate(AOU_ano = AOU - AOU_month,
         OSAT_ano = OSAT - OSAT_month,
         neg_AOU_ano = neg_AOU - neg_AOU_month,
         DO_ano = oxy_umol_kg - DO_month)


# Regression and table anomalies
var_list <- c("AOU_ano", "OSAT_ano", "neg_AOU_ano", "DO_ano")

lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), data = anomalies_AOU_surf))
})

reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}
colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg) <- var_list
reg_ano_AOU_surf <- reg

#reg_ano_AOU_surf 


#plot anomalies AOU surface :
plot_ano_AOU_surf <- ggplot(data = anomalies_AOU_surf, aes(x = datetime, y = AOU_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="#22427C", na.rm=TRUE, size = 0.7) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title="",x="", y=expression(paste("AOU (µmol ", kg^-1, ")")))
#  annotate(geom="text", x=as.POSIXct("2012-03-20"), y=80, label="slope : -0.49 ± 0.058 *", color="black")


plot_AOU_surf <- data_somlit_surf %>% 
  ggplot() + 
  aes(x=datetime, y=AOU) + 
  geom_line(size = 0.5) + 
  scale_x_datetime(name="", date_breaks = "4 years", date_minor_breaks = "1 year", date_labels = "%Y") + 
  scale_y_continuous(name=expression(paste("AOU (µmol ", kg^-1, ")")))


plot_AOU_surf
plot_ano_AOU_surf

plot_grid(plot_AOU_surf, plot_ano_AOU_surf, align='vh', ncol=2)

```
  
  
  
→ Plot mean annual anomalies of O~2~, O~2~sat and negative AOU (Mavropoulou et al., 2020)  
  
Negative AOU and dissolved oxygen are similar in magnitude all over the period  
O~2~sat is close to zero  
DO and O~2~sat are similar in magnitude on 2 periods : 2002-2005 and 2011-2017  
  
→ thus, out of these two periods, the solubility changes have a secondary role in the observed dissolved oxygen variations  
  

```{r plot mean annual O2, O2 sat & AOU monthly means, echo=FALSE, warning=FALSE, message=FALSE, fig.width=9,fig.height=4}

anomalies_AOU_surf <- anomalies_AOU_surf %>% 
  group_by(year) %>% 
  mutate(mean_neg_AOU_ano = mean(neg_AOU_ano, na.rm=TRUE),
         mean_OSAT_ano = mean(OSAT_ano, na.rm=TRUE),
         mean_DO_ano = mean(DO_ano, na.rm=TRUE),
         mean_AOU_ano = mean(AOU_ano, na.rm = TRUE))

plot_AOU_rap1 <- anomalies_AOU_surf %>%
ggplot() + 
  geom_point(aes(x=year, y=mean_AOU_ano), col="black") +
  geom_line(aes(x=year, y=mean_AOU_ano), col="black") +
  geom_point(aes(x=year, y=mean_OSAT_ano), col="darkred") +
  geom_line(aes(x=year, y=mean_OSAT_ano), col="darkred") +
  geom_point(aes(x=year, y=mean_DO_ano), col="#1E7FCB") + 
  geom_line(aes(x=year, y=mean_DO_ano), col="#1E7FCB") +
  scale_y_continuous(name=expression(paste("Concentrations en µmol ", kg^-1))) +
  scale_x_continuous(name="", breaks = seq(from = 2002, to = 2022, by = 2), labels = NULL)

plot_AOU_rap1

```
  
  
###### Trend analysis by moving average (decompose function) :  
  
*Quick overview of the components of the series*   
  

```{r decompose function - AOU surface, echo=FALSE, warning=FALSE, message=FALSE}

#AOU time-series :
AOU_ts <- ts(data_somlit_surf$AOU, start = c(2002,2), end = c(2022,52), freq = 52)

#type = additive because the seasonal pattern doesn't seem to increase in variation, seasonal pattern looks constant
AOU_ts_decomp <- decompose(AOU_ts, type = "additive") #pareil qu'en rajoutant : filter = rep(1/52,52)

autoplot(AOU_ts_decomp) +
  xlab('')


# plot(AOU_ts_decomp$x, col="black")
# lines(AOU_ts_decomp$seasonal, col="red")

#plot(AOU_ts_decomp$figure)
```
  
  
→ Remove seasonality :  
  
measured values - seasonal pattern  
OR  
trend + remainders  
  
*applying trend on the outputed series*  
  

```{r remove seasonal pattern - AOU surface, echo=FALSE, warning=FALSE, message=FALSE}

#2 ways :
# 1 : measured values - seasonal pattern
# 2 : trend + random

AOU_ts_less_season <- AOU_ts_decomp$x - AOU_ts_decomp$seasonal

plot_AOU_ts_less_season <- autoplot(AOU_ts_less_season) + 
  xlab("") + ylab("AOU (µmol/kg)") +
  ggtitle("AOU surface time series (without seasonality)") +
  geom_smooth(method=lm)

#regression AOU surface values :
reg_val_AOU_less_season <- as.data.frame(plot_AOU_ts_less_season$data)

model_AOU_less_season <- lm(formula=y~x, data=reg_val_AOU_less_season)
summary(model_AOU_less_season) #pour voir les erreurs des coef + la significativité


#plot with slope value :
plot_AOU_ts_less_season <- autoplot(AOU_ts_less_season) + 
  xlab("") + ylab("AOU (µmol/kg)") +
  ggtitle("AOU surface time series (without seasonality)") +
  geom_smooth(method=lm) +
  annotate(geom="text", x=2013, y=57, label="slope : -0.48 ± 0.060 *", color="black")

plot_AOU_ts_less_season



```
  
  
  
###### → 50 m data :  
  
```{r AOU calculation - SOMLIT prof, echo=FALSE, warning=FALSE, message=FALSE}

#calcul T1 :
T1_prof <- (data_somlit_prof$T + 273.15) / 100

#calcul OSAT_prof (ml/kg) :
OSAT_prof = (-173.9894) + 255.5907/T1_prof + 146.4813*log(T1_prof) - 22.2040*T1_prof
OSAT_prof = OSAT_prof + data_somlit_prof$S * (-0.037362 + T1_prof * (0.016504 - 0.0020564 * T1_prof))
OSAT_prof = exp(OSAT_prof)

#convert from ml/kg to umol/kg : NON
#OSAT_prof = (OSAT_prof * 1000)/ 22.392

#calculate AOU in umol/kg
AOU_som_prof = OSAT_prof - data_somlit_prof$oxy_umol_kg


data_somlit_prof <- cbind(data_somlit_prof, AOU_som_prof)
data_somlit_prof <- cbind(data_somlit_prof, OSAT_prof)

summary(data_somlit_prof)

#negative AOU (Garcia et al., 2005)
# −AOU = O2 − OSAT

data_somlit_prof <- data_somlit_prof %>% 
  mutate(neg_AOU = oxy_umol_kg - OSAT_prof) %>% 
  group_by(year) %>% 
  mutate(mean_AOU = mean(AOU_som_prof, na.rm = T)) 
```
  

→ AOU (50m) annual cycle : low values in summer  
  
Temperature and DO have a weak correlation, lower than in surface (r = -0.21) : when temp. increases, DO decreases  
  

```{r AOU 50m + annual cycle, echo=FALSE, warning=FALSE, message=FALSE}

plot_AOU_prof_annual_cycle <- data_somlit_prof %>% 
  ggplot() +
  geom_line(aes(x = as.Date(yday(datetime), "1970-01-01"), y = AOU_som_prof, 
                group = factor(year(datetime)), 
                color = factor(year(datetime))), linewidth = 0.6) +
  scale_colour_viridis_d(option="mako", direction=-1) +
  ggtitle("Annual cycle of AOU (50 m) - Point B (2002-2022)") +
  scale_x_date(date_breaks="months", date_labels="%b", name = "") +
  labs(x="Months",colour="") +
  theme_bw() +
  scale_y_continuous(name = "AOU (µmol/kg)") 

plot_AOU_prof_annual_cycle
##

#scatter plot DO vs T
data_somlit_prof %>% 
  ggplot() +
  aes(x=T, y=oxy_umol_kg) + 
  geom_point() + 
  scale_x_continuous(name="Temp. (°C)") + 
  scale_y_continuous(name="DO (µmol/kg)") +
  ggtitle("Correlation between temperature and issolved at Point B (2002-2022)") +
  geom_smooth(method=lm) + 
  annotate(geom="text", x=22, y=125, label="slope : -1.88 ± 0.26 *", color="black")

#summary(lm(data_somlit_prof$oxy_umol_kg ~ data_somlit_prof$T))
#cor(data_somlit_prof$T, data_somlit_prof$oxy_umol_kg, method="pearson")
##

#Mean AOU by year :

data_somlit_prof <- data_somlit_prof %>% 
  group_by(year) %>% 
  mutate(mean_AOU = mean(AOU_som_prof, na.rm = T))
  
data_somlit_prof %>% 
  ggplot() +
  aes(x=year, y=mean_AOU) +
  geom_point(shape = 7, size = 2, col="brown") +
  geom_line() +
  scale_x_discrete(name="", limits=c("2002" : "2022")) + 
  scale_y_continuous(name="AOU (µmol/kg)") +
  ggtitle("Mean of AOU per year at Point B - 50 m (2002-2022)")




```
  
  
  
###### Trend analysis by residuals - AOU - 50m (Bates et al. 2014) :  
  
AOU : negative trend, but less than in surface  
Inverse relation between AOU and observed O~2~  
*slope : -0.37 ± 0.07 µmol/kg par année* 

```{r trend analysis AOU - 50m, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=1.5}

## Monthly means AOU surface :
monthly_means_AOU_prof <- ungroup(data_somlit_prof) %>% 
  group_by(month) %>%
  summarise(AOU_month = mean(AOU_som_prof, na.rm = TRUE),
            neg_AOU_month = mean(neg_AOU, na.rm=TRUE),
            OSAT_month = mean(OSAT_prof, na.rm=TRUE),
            DO_month = mean(oxy_umol_kg, na.rm=TRUE))

##

## Parameters

anomalies_AOU_prof <- left_join(ungroup(data_somlit_prof), monthly_means_AOU_prof, by = "month") %>%
  mutate(AOU_ano = AOU_som_prof - AOU_month,
         neg_AOU_ano = neg_AOU - neg_AOU_month,
         OSAT_ano = OSAT_prof - OSAT_month,
         DO_ano = oxy_umol_kg - DO_month)


# Regression and table anomalies
var_list <- c("AOU_ano", "neg_AOU_ano", "OSAT_ano", "DO_ano")

lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), data = anomalies_AOU_prof))
})

reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}
colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg) <- var_list
reg_ano_AOU_prof <- reg

#reg_ano_AOU_prof 


#plot anomalies AOU surface :
plot_ano_AOU_prof <- ggplot(data = anomalies_AOU_prof, aes(x = datetime, y = AOU_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="#22427C", na.rm=TRUE, size = 0.7) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title="",x="", y=expression(paste("AOU (", mu, "mol ", kg^-1, ")"))) 
#  annotate(geom="text", x=as.POSIXct("2012-03-20"), y=80, label="slope : -0.38 ± 0.07 *", color="black")

plot_AOU_prof <- data_somlit_prof %>% 
  ggplot() + 
  aes(x=datetime, y=AOU_som_prof) + 
  geom_line(col = "black", size = 0.5) + 
  scale_x_datetime(name="", date_breaks = "4 years", date_minor_breaks = "1 year", date_labels = "%Y") + 
  scale_y_continuous(name=expression(paste("AOU (", mu, "mol ", kg^-1, ")")))


plot_AOU_prof
plot_ano_AOU_prof


plot_grid(plot_AOU_prof, plot_ano_AOU_prof, ncol=2)

```
  
  
→ Plot mean annual anomalies of O~2~, O~2~sat and negative AOU (Mavropoulou et al., 2020)  
  
Negative AOU and dissolved oxygen are similar in magnitude all over the period  
O~2~sat is close to zero  
DO and O~2~sat are similar in magnitude only for 2002-2004  
  
→ thus, the solubility changes have a secondary role in the observed dissolved oxygen variations  
  

```{r plot mean annual O2, O2 sat & AOU monthly means - 50m, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=6}

anomalies_AOU_prof <- anomalies_AOU_prof %>% 
  group_by(year) %>% 
  mutate(mean_neg_AOU_ano = mean(neg_AOU_ano, na.rm=TRUE),
         mean_OSAT_ano = mean(OSAT_ano, na.rm=TRUE),
         mean_DO_ano = mean(DO_ano, na.rm=TRUE),
         mean_AOU_ano = mean(AOU_ano, na.rm = TRUE))

plot_AOU_rap <- anomalies_AOU_prof %>%
ggplot() + 
  geom_point(aes(x=year, y=mean_AOU_ano), col="black") +
  geom_line(aes(x=year, y=mean_AOU_ano), col="black") +
  geom_point(aes(x=year, y=mean_OSAT_ano), col="darkred") +
  geom_line(aes(x=year, y=mean_OSAT_ano), col="darkred") +
  geom_point(aes(x=year, y=mean_DO_ano), col="#1E7FCB") + 
  geom_line(aes(x=year, y=mean_DO_ano), col="#1E7FCB") +
  scale_y_continuous(name=expression(paste("Concentrations en µmol ", kg^-1))) +
  scale_x_continuous(name="", breaks = seq(from = 2002, to = 2022, by = 2))

plot_AOU_rap

plot_grid(plot_AOU_rap1 ,plot_AOU_rap, align='vh', ncol=1)


```
  
  
###### Trend analysis by moving average (decompose function) :  
  
*Quick overview of the components of the series*   
  

```{r decompose function - AOU 50m, echo=FALSE, warning=FALSE, message=FALSE}

#AOU time-series :
AOU_ts_prof <- ts(data_somlit_prof$AOU_som_prof, start = c(2002,2), end = c(2022,52), freq = 52)


#type = additive because the seasonal pattern doesn't seem to increase in variation, seasonal pattern looks constant
AOU_ts_prof_decomp <- decompose(AOU_ts_prof, type = "additive")

autoplot(AOU_ts_prof_decomp) +
  xlab('')

```
  
  
→ Remove seasonality :  
  
*applying trend on the outputed series*  
  

```{r remove seasonal pattern - AOU 50m, echo=FALSE, warning=FALSE, message=FALSE}

#2 ways :
# 1 : measured values - seasonal pattern
# 2 : trend + random

AOU_ts_prof_less_season <- AOU_ts_prof_decomp$x - AOU_ts_prof_decomp$seasonal

plot_AOU_ts_prof_less_season <- autoplot(AOU_ts_prof_less_season) + 
  xlab("") + ylab("AOU (µmol/kg)") +
  ggtitle("AOU 50 m depth time series (without seasonality)") +
  geom_smooth(method=lm)

#regression AOU surface values :
reg_val_AOU_prof_less_season <- as.data.frame(plot_AOU_ts_prof_less_season$data)

model_AOU_prof_less_season <- lm(formula=y~x, data=reg_val_AOU_prof_less_season)
summary(model_AOU_prof_less_season) #pour voir les erreurs des coef + la significativité


#plot with slope value :
plot_AOU_ts_prof_less_season <- autoplot(AOU_ts_prof_less_season) + 
  xlab("") + ylab("AOU (µmol/kg)") +
  ggtitle("AOU 50 m depth time series (without seasonality)") +
  geom_smooth(method=lm) +
  annotate(geom="text", x=2013, y=57, label="slope : -0.33 ± 0.067 *", color="black")

plot_AOU_ts_prof_less_season


```
  
  
## Comparison AOU EOL-Point B (2018-2022)  
  
EOL : weekly data, at 09h AM  
  
```{r Comparison AOU EOL-Point B, echo=FALSE, warning=FALSE, message=FALSE}

#EOL sorting :
data_EOL <- data_EOL %>% 
  mutate(Hour = as.character(Hour))

EOL_1822 <- data_EOL %>% 
  dplyr::filter(Hour == "09:00:00") %>% 
  mutate(datetime = as.character(datetime)) %>% 
  dplyr::select(datetime, oxy_umol_kg, AOU, OSAT, neg_AOU) %>% 
  rename(oxy_EOL = oxy_umol_kg, AOU_EOL = AOU, OSAT_EOL = OSAT, neg_AOU_EOL = neg_AOU)

#Point B sorting :
# data_somlit_surf <- data_somlit_surf %>% 
#   separate(datetime, into=c("datetime", "Hour"), sep=" ") %>% 
#   dplyr::select(datetime, oxy_umol_kg, AOU, OSAT, neg_AOU) %>% 
#   rename(oxy_som = oxy_umol_kg, AOU_som = AOU, OSAT_som = OSAT, neg_AOU_som = neg_AOU)

EOL_somlit_1822 <- left_join(data_somlit_surf, EOL_1822, by="datetime")

EOL_somlit_1822 <- EOL_somlit_1822 %>% 
  dplyr::filter(year >= "2018") %>% 
  mutate(datetime = as.POSIXct(datetime))

#plot AOU :
EOL_somlit_1822 %>% 
  ggplot() + 
  geom_line(aes(x=datetime, y=AOU_EOL), col="orange") +
  geom_line(aes(x=datetime, y=AOU_som), col="darkblue") +
  scale_x_datetime(name="", date_breaks = "1 year", date_labels = "%Y") +
  scale_y_continuous(name=expression(paste("AOU (μmol", ".", kg^-1, ")"))) +
  ggtitle("AOU surface (2018-2022) : EOL = orange, Point B = blue")


#plot rapport


```
  
  
Moving average + Mann Kendall for AOU at Point B (2018-2022)  
  

```{r tendances AOU EOL - PointB - 2018-2022, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=9}


#AOU time-series :
JJ <- EOL_somlit_1822$AOU_EOL[c(1:246)]
JJ <- na_seadec(JJ, algorithm = "interpolation")
AOU_EOL_1822_ts <- ts(JJ, start = c(2018,1), end = c(2022,39), freq = 52)
AOU_som_1822_ts <- ts(EOL_somlit_1822$AOU_som, start = c(2018,1), end = c(2022,52), freq = 52)

AOU_EOL_test_ts <- ts(na.omit(data_EOL$AOU), start = c(2018,1), end = c(2022,(325*24)), freq = (365*24))


#type = additive or multiplicative
AOU_EOL_1822_ts_decomp <- decompose(AOU_EOL_1822_ts, type = "additive") #pareil qu'en rajoutant : filter = rep(1/52,52)
AOU_som_1822_ts_decomp <- decompose(AOU_som_1822_ts, type = "additive")

AOU_EOL_test_ts_decomp <- decompose(AOU_EOL_test_ts, type = "multiplicative")

 autoplot(AOU_EOL_test_ts_decomp) +
   xlab('')



##remove seasonality :
AOU_EOL_1822_ts_less_season <- AOU_EOL_1822_ts_decomp$x - AOU_EOL_1822_ts_decomp$seasonal
AOU_som_1822_ts_less_season <- AOU_som_1822_ts_decomp$x - AOU_som_1822_ts_decomp$seasonal

AOU_EOL_test_ts_less_season <- AOU_EOL_test_ts_decomp$x - AOU_EOL_test_ts_decomp$seasonal
  
plot_AOU_EOL_1822_ts_less_season <- autoplot(AOU_EOL_1822_ts_less_season) + 
  xlab("") + ylab("AOU (µmol/kg)") +
  geom_smooth(method=lm)
  
plot_AOU_som_1822_ts_less_season <- autoplot(AOU_som_1822_ts_less_season) + 
  xlab("") + ylab("AOU (µmol/kg)") +
  geom_smooth(method=lm)

plot_AOU_EOL_test_ts_less_season <- autoplot(AOU_EOL_test_ts_less_season) + 
  xlab("") + ylab("AOU (µmol/kg)") +
  geom_smooth(method=lm)

#regression AOU values :
reg_val_AOU_EOL_1822_ts_less_season <- as.data.frame(plot_AOU_EOL_1822_ts_less_season$data)

model_AOU_EOL_1822_ts_less_season <- lm(formula=y~x, data=reg_val_AOU_EOL_1822_ts_less_season)
summary(model_AOU_EOL_1822_ts_less_season) #1.2293


reg_val_AOU_som_1822_ts_less_season <- as.data.frame(plot_AOU_som_1822_ts_less_season$data)

model_AOU_som_1822_ts_less_season <- lm(formula=y~x, data=reg_val_AOU_som_1822_ts_less_season)
summary(model_AOU_som_1822_ts_less_season) #0.28 (non-significative)


reg_val_AOU_EOL_test_ts_less_season <- as.data.frame(plot_AOU_EOL_test_ts_less_season$data)

model_AOU_EOL_test_ts_less_season <- lm(formula=y~x, data=reg_val_AOU_EOL_test_ts_less_season)
summary(model_AOU_EOL_test_ts_less_season) #1.21


#plot with slope value :
plot_AOU_EOL_1822_ts_less_season <- autoplot(AOU_EOL_1822_ts_less_season) + 
  xlab("") + ylab("AOU (µmol/kg)") +
  ggtitle("AOU time series at EOL weekly (without seasonality)") +
  geom_smooth(method=lm) +
  annotate(geom="text", x=2019, y=30, label="slope : 1.22 ± 0.29 *", color="black")


#plot with slope value :
plot_AOU_som_1822_ts_less_season <- autoplot(AOU_som_1822_ts_less_season) + 
  xlab("") + ylab("AOU (µmol/kg)") +
  ggtitle("AOU time series at Point B weekly (without seasonality)") +
  geom_smooth(method=lm) +
  annotate(geom="text", x=2020, y=50, label="slope : 0.28 ± 0.40 (non-significative)", color="black")

#plot with slope value :
plot_AOU_EOL_test_ts_less_season <- autoplot(AOU_EOL_test_ts_less_season ) + 
  xlab("") + ylab(expression(paste("AOU (µmol", .kg^-1, ")"))) +
  ggtitle("AOU time series at EOL Hourly (without seasonality)") +
  geom_smooth(method=lm) +
  annotate(geom="text", x=2019, y=20, label="slope : 1.21 ± 0.031 *", color="black")


plot_grid(plot_AOU_EOL_test_ts_less_season, plot_AOU_EOL_1822_ts_less_season, plot_AOU_som_1822_ts_less_season, align='vh', ncol=1)

FFAOU_som <- kendallSeasonalTrendTest(AOU_som ~ month(datetime) + year(datetime), data = EOL_somlit_1822)

#pour EOL hourly :
FFAOU_EOLh <- kendallSeasonalTrendTest(AOU_EOL ~ month(datetime) + year(datetime), data = EOL_somlit_1822)

# FFAOU_surf <- kendallSeasonalTrendTest(AOU_som ~ month(datetime) + year(datetime), data = data_somlit_surf)
# FFAOU_surf$estimate
# 
# FFAOU_prof <- kendallSeasonalTrendTest(AOU_som ~ month(datetime) + year(datetime), data = data_somlit_prof)
# FFAOU_prof$estimate


#plot rapport :

plot1 <- autoplot(AOU_EOL_test_ts)
plot2 <- autoplot(AOU_som_1822_ts)

plot_grid(plot1, plot2, align='vh', ncol=1)

```
  
  
Trend analysis by residuals :  
  

```{r Pt B anomalies - 2018-2022}

EOL_somlit_1822 <- EOL_somlit_1822 %>% 
  mutate(Month = format(datetime, format="%m"))

#monthly means

monthly_means_somlit <- ungroup(EOL_somlit_1822) %>% 
  mutate(Month = format(datetime, format="%m")) %>% 
  group_by(Month) %>%
  summarise(
    AOU_month = mean(AOU_som, na.rm = TRUE))

#anomalies

anomalies_somlit <- left_join(ungroup(EOL_somlit_1822), monthly_means_somlit, by = "Month") %>%
  mutate(AOU_ano = AOU_som - AOU_month)

# Regression and table anomalies
var_list <- c("AOU_ano")

lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), 
             data = anomalies_somlit))
})
reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}
colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")

row.names(reg) <- var_list
reg_anomalies_somlit <- reg

reg_anomalies_somlit

```



```{r notes 1, echo=FALSE, warning=FALSE, message=FALSE}

#faire comparaison temp pot, prend en compte la salinity, voit l'effet de la solubilité, il doit etre hyper dépendant des processus de solubilité et donc de TS en surface
#comme article

#papiers Laurent

#interpreter les donnees d'AOU


#temperature impactent o2. significatif, temp potentiel
#solubilité CO2 plus elevee que celle de l'o2
#hivers plus doux et plus court donc moins de penetration d'o2 dans l'ocean

###correction oxygen EOL :
#graph montrant uniquement la relation entre les data corrigées EOL + data Point B (oxygen)
#voir avec Samir la correction data, revoir le script, faire avec liste rotation des capteurs (mail Laurent)
#voir janvier 2018 fin 2022 entre EOL et data somlit, faire la relation linéaire

```







